@using System.Runtime.InteropServices.JavaScript
@using TrainerCourse.Shared.Method
@using TrainerCourse.Shared.Services
@using Microsoft.JSInterop
@inject ICameraService CameraService
@inject ICourseService CourseService
@inject IJSRuntime JSRuntime

<div class="camera-component">
    <div class="form-group">
        <label>@Title</label>

        @if (!string.IsNullOrEmpty(ImageUrl))
        {
            <div class="image-preview mb-2">
                <img src="@ImageUrl" alt="Captured image" class="img-thumbnail" style="max-height: 200px;" />
                <button type="button" class="btn btn-sm btn-outline-danger mt-2" @onclick="RemoveImage">
                    <i class="bi bi-trash"></i> Remove Image
                </button>
            </div>
        }

        <button type="button" class="btn btn-info w-100" @onclick="CapturePhoto" disabled="@IsCapturing">
            @if (IsCapturing)
            {
                <span>
                    <div class="spinner-border spinner-border-sm" role="status">
                        <span class="visually-hidden">Capturing...</span>
                    </div>
                    Capturing...
                </span>
            }
            else
            {
                <span>
                    <i class="bi bi-camera"></i> @ButtonText
                </span>
            }
        </button>

        @if (!string.IsNullOrEmpty(Message))
        {
            <div class="alert @(Message.Contains("success") ? "alert-success" : "alert-danger") mt-2">
                @Message
            </div>
        }

        <div class="form-text">
            @HelpText
        </div>
    </div>
</div>

@code {

    [Parameter]
    public string Title { get; set; } = "Camera Capture";

    [Parameter]
    public string ButtonText { get; set; } = "Take Photo";

    [Parameter]
    public string HelpText { get; set; } = "Capture photo using device camera";

    [Parameter]
    public string? ImageUrl { get; set; }

    [Parameter]
    public string? ImageFileName { get; set; }

    [Parameter]
    public EventCallback<string> ImageUrlChanged { get; set; }

    [Parameter]
    public EventCallback<string> ImageFileNameChanged { get; set; }

    private bool IsCapturing { get; set; }
    private string Message { get; set; } = string.Empty;
    private IJSObjectReference? cameraModule;

    private async Task CapturePhoto()
    {
        IsCapturing = true;
        Message = string.Empty;
        StateHasChanged();

        try
        {
            // Check if we're in a web environment with JavaScript support
            if (JSRuntime != null)
            {
                // Import the camera module if not already imported
                if (cameraModule == null)
                {
                    cameraModule = await JSRuntime.InvokeAsync<IJSObjectReference>("import", "./js/camera.js");
                }

                // Start the camera
                var isStarted = await cameraModule.InvokeAsync<bool>("startCamera");

                if (!isStarted)
                {
                    Message = "Failed to start camera. Please check permissions.";
                    return;
                }

                // Wait a moment for camera to initialize
                await Task.Delay(300);

                // Capture photo as Base64 data URL
                var imageDataUrl = await cameraModule.InvokeAsync<string>("capturePhoto");

                if (string.IsNullOrEmpty(imageDataUrl))
                {
                    Message = "Failed to capture photo. Please try again.";
                    return;
                }

                // Stop the camera after capture
                await cameraModule.InvokeVoidAsync("stopCamera");

                // Upload directly to backend API
                var uploadResult = await CourseService.UploadCameraImageAsync(imageDataUrl, $"camera_{DateTime.Now:yyyyMMdd_HHmmss}.jpg");

                if (uploadResult.Success && !string.IsNullOrEmpty(uploadResult.FileName))
                {
                    ImageFileName = uploadResult.FileName;
                    ImageUrl = uploadResult.ImageUrl;

                    // Invoke callbacks to update parent component
                    await ImageFileNameChanged.InvokeAsync(ImageFileName);
                    await ImageUrlChanged.InvokeAsync(ImageUrl);

                    Message = "Photo captured and uploaded successfully!";
                }
                else
                {
                    Message = uploadResult.Message ?? "Failed to upload photo to server.";
                }
            }
            else
            {
                // Fallback for non-web environments (MAUI native)
                var result = await CameraService.TakePhotoAsync();

                if (result.Success)
                {
                    ImageFileName = result.FileName;
                    ImageUrl = result.ImageUrl;

                    await ImageFileNameChanged.InvokeAsync(ImageFileName);
                    await ImageUrlChanged.InvokeAsync(ImageUrl);

                    Message = result.Message ?? "Photo captured successfully!";
                }
                else
                {
                    Message = result.Message ?? "Failed to capture photo";
                }
            }
        }
        catch (Microsoft.JSInterop.JSException jsEx)
        {
            Message = $"JavaScript error: {jsEx.Message}. Make sure camera.js is in wwwroot/js/ folder.";
        }
        catch (HttpRequestException httpEx)
        {
            Message = $"Network error: {httpEx.Message}. Check backend connection.";
        }
        catch (Exception ex)
        {
            Message = $"Error: {ex.Message}";
        }
        finally
        {
            IsCapturing = false;
            StateHasChanged();
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            cameraModule = await JSRuntime.InvokeAsync<IJSObjectReference>("import", "./js/camera.js");
        }
    }

    private async Task RemoveImage()
    {
        ImageUrl = null;
        ImageFileName = null;

        await ImageUrlChanged.InvokeAsync(null);
        await ImageFileNameChanged.InvokeAsync(null);

        Message = string.Empty;
        StateHasChanged();
    }
}
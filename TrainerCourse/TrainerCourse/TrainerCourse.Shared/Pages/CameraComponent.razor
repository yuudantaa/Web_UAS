@using TrainerCourse.Shared.Services
@inject ICameraService CameraService
@inject IJSRuntime JSRuntime

<div class="camera-component">
    <div class="form-group">
        <label>@Title</label>

        @if (!string.IsNullOrEmpty(ImageUrl))
        {
            <div class="image-preview mb-2">
                <img src="@ImageUrl" alt="Captured image" class="img-thumbnail" style="max-height: 200px;" />
                <button type="button" class="btn btn-sm btn-outline-danger mt-2" @onclick="RemoveImage">
                    <i class="bi bi-trash"></i> Remove Image
                </button>
            </div>
        }

        <button type="button" class="btn btn-info w-100" @onclick="CapturePhoto" disabled="@IsCapturing">
            @if (IsCapturing)
            {
                <span>
                    <div class="spinner-border spinner-border-sm" role="status">
                        <span class="visually-hidden">Capturing...</span>
                    </div>
                    Capturing...
                </span>
            }
            else
            {
                <span>
                    <i class="bi bi-camera"></i> @ButtonText
                </span>
            }
        </button>

        @if (!string.IsNullOrEmpty(Message))
        {
            <div class="alert @(Message.Contains("success") ? "alert-success" : "alert-danger") mt-2">
                @Message
            </div>
        }

        <div class="form-text">
            @HelpText
        </div>
    </div>
</div>

@code {
    [Parameter]
    public string Title { get; set; } = "Camera Capture";

    [Parameter]
    public string ButtonText { get; set; } = "Take Photo";

    [Parameter]
    public string HelpText { get; set; } = "Capture photo using device camera";

    [Parameter]
    public string? ImageUrl { get; set; }

    [Parameter]
    public string? ImageFileName { get; set; }

    [Parameter]
    public EventCallback<string> ImageUrlChanged { get; set; }

    [Parameter]
    public EventCallback<string> ImageFileNameChanged { get; set; }

    private bool IsCapturing { get; set; }
    private string Message { get; set; } = string.Empty;

    private async Task CapturePhoto()
    {
        IsCapturing = true;
        Message = string.Empty;
        StateHasChanged();

        try
        {
            var result = await CameraService.TakePhotoAsync();

            if (result.Success)
            {
                ImageFileName = result.FileName;
                ImageUrl = result.ImageUrl;

                await ImageFileNameChanged.InvokeAsync(ImageFileName);
                await ImageUrlChanged.InvokeAsync(ImageUrl);

                Message = result.Message ?? "Photo captured successfully!";
            }
            else
            {
                Message = result.Message ?? "Failed to capture photo";
            }
        }
        catch (Exception ex)
        {
            Message = $"Error: {ex.Message}";
        }
        finally
        {
            IsCapturing = false;
            StateHasChanged();
        }
    }

    private async Task RemoveImage()
    {
        ImageUrl = null;
        ImageFileName = null;

        await ImageUrlChanged.InvokeAsync(null);
        await ImageFileNameChanged.InvokeAsync(null);

        Message = string.Empty;
        StateHasChanged();
    }
}